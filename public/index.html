<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

  <title>SelFit - Do IT yourself</title>

  <!-- Required Stylesheets -->
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css" />

  <!-- Required scripts -->
  <script src="https://unpkg.com/vue"></script>
  <script src="https://unpkg.com/babel-polyfill@latest/dist/polyfill.min.js"></script>
  <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>

  <!-- Load Vue followed by BootstrapVueIcons -->
  <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue-icons.min.js"></script>
</head>

<body>
  <div id="app">
    <b-navbar toggleable="lg" type="dark" variant="dark">
      <b-navbar-brand>SelFit©</b-navbar-brand>

      <b-navbar-toggle target="nav-collapse"></b-navbar-toggle>

      <b-collapse id="nav-collapse" is-nav>
        <b-navbar-nav>
          <b-nav-item href="http://localhost:9000/web/">Home</b-nav-item>
        </b-navbar-nav>

        <!-- Right aligned nav items -->
        <b-navbar-nav class="ml-auto">
          <!-- <b-nav-form>
            <b-form-input size="sm" class="mr-sm-2" placeholder="Buscar posts"></b-form-input>
            <b-button size="sm" class="my-2 my-sm-0" type="submit">Buscar</b-button>
          </b-nav-form> -->

          <b-nav-item-dropdown right>
            <!-- Using 'button-content' slot -->
            <template #button-content>
              <em>Log in</em>
            </template>
            <b-dropdown-item v-b-modal.modal-1>Iniciar Sesion</b-dropdown-item>
            <b-modal id="modal-1" centered title="Iniciar Sesión" hide-footer>
              <div class="row justify-content-center">
                <div>

                  <div class="card-body">
                    <div class="tab-content" id="pills-tabContent">
                      <div class="tab-pane fade show active" id="pills-beneficiary" role="tabpanel"
                        aria-labelledby="pills-beneficiary-tab">
                        <div class="vue-template">
                          <form>
                            <div class="form-group">
                              <h4>Usuario</h4>
                              <input type="text" class="form-control form-control-lg" required />
                            </div>

                            <div class="form-group">
                              <h4>Contraseña</h4>
                              <input type="password" class="form-control form-control-lg" required />
                            </div>

                            <button type="submit" class="btn btn-dark btn-lg btn-block">Iniciar sesión</button>

                            <p class="forgot-password text-right">
                              ¿No tienes cuenta?
                              <b-link v-b-modal.modal-2 @click="$bvModal.hide('modal-1')"> Regístrate</b-link>
                            </p>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </b-modal>
            <b-dropdown-item v-b-modal.modal-2>Regístrate</b-dropdown-item>
            <b-modal id="modal-2" centered title="Regístrate" hide-footer>
              <div class="row justify-content-center">
                <div>
                  <div class="card-body">
                    <div class="tab-content" id="pills-tabContent">
                      <div class="tab-pane fade show active" id="pills-beneficiary" role="tabpanel"
                        aria-labelledby="pills-beneficiary-tab">
                        <div class="vue-template">
                          <form id="registerForm" v-on:submit.prevent="">
                            <div class="form-group">
                              <h4>Usuario</h4>
                              <input type="text" id="regUser" name="usuario" class="form-control form-control-lg"
                                required />
                            </div>
                            <div class="form-group">
                              <h4>Email</h4>
                              <input type="text" id="regEmail" name="regEmail" class="form-control form-control-lg"
                                required />
                            </div>
                            <div class="form-group">
                              <h4>Contraseña</h4>
                              <input type="password" id="regContraseña" name="regContraseña"
                                class="form-control form-control-lg" required />
                            </div>
                            <button @click="createUser()+$bvModal.hide('modal-2')"
                              class="btn btn-dark btn-lg btn-block">Regístrate</button>

                            <p class="forgot-password text-right">
                              ¿Ya tienes cuenta?
                              <b-link v-b-modal.modal-1 @click="$bvModal.hide('modal-2')"> Inicia Sesión</b-link>
                            </p>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </b-modal>
          </b-nav-item-dropdown>
        </b-navbar-nav>
      </b-collapse>
    </b-navbar>

    <b-container class="mt-4">
      <div>
        <b-dropdown text="Categorías" right class="mb-2">
          <!-- <b-form-button v-model="selected" :aria-describedby="ariaDescribedby" name="some-radios" value="comida"> -->
          <b-dropdown-item name="categoria" value="comida">
            Comida</b-form-button>
          </b-dropdown-item>

          <b-dropdown-item href="#">
            <b-form-button name="categoria" value="ejercicio">
              Ejercicio</b-form-button>
          </b-dropdown-item>

          <b-dropdown-item href="#">
            <b-form-button name="categoria" value="vida">
              Estilo de vida</b-form-button>
          </b-dropdown-item>
        </b-dropdown>

        <b-button v-b-modal.modal-3 class="mb-2" style="float:right;">
          <b-icon icon="pencil-square"></b-icon>
        </b-button>

        <b-modal id="modal-3" size="xl" title="Crear un blog" centered hide-footer hide-header>
          <div>
            <h3>Crear un blog</h3>
          </div>
          <div class="form-group">
            <label for="Titulo">Título</label>
            <input type="text" class="form-control" id="titulo" placeholder="Escribe un título.">
          </div>

          <div>
            <b-form-group label="Categoría:" v-slot="{ ariaDescribedby }">
              <b-form-radio-group
                id="categoria"
                :aria-describedby="ariaDescribedby"
                name="radio-sub-component"
              >
                <b-form-radio value="comida">Comida</b-form-radio>
                <b-form-radio value="ejercicio">Ejercicio</b-form-radio>
                <b-form-radio value="estilo">Estilo de vida</b-form-radio>
              </b-form-radio-group>
            </b-form-group>
          </div>
          <div class="form-group">
            <label for="Textarea">Contenido</label>
            <textarea class="form-control" id="contenidoPost" rows="15"></textarea>
          </div>

          <button @click="$bvModal.hide('modal-3')" class="btn btn-dark btn-lg" style="float:right; margin:5px">Cancelar</button>
          <button @click="createBlog()+$bvModal.hide('modal-3')" class="btn btn-dark btn-lg" style="float:right; margin:5px">Crear</button>

        </b-modal>

        <b-form @submit="searchBlogs" class="input-group" v-on:submit.prevent="">
          <b-form-input v-model.trim="query" size="sm" class="mr-sm-2" placeholder="Buscar posts"
            @keyup.enter="searchBlogs"></b-form-input>
          <b-button type="submit" size="sm" class="my-2 my-sm-0">Buscar</button>
        </b-form>
      </div>
      <b-container class="mt-2" v-show="blogs.length>0">
        <b-card>
          <ul style="list-style-type:none">
            <li style="list-style-type:none" v-for="blog in blogs">
              <b-dropdown type="light" variant="light" size="lg" :text="blog.name" class="mb-3">
                <b-dropdown-header>{{blog.description}}</b-dropdown-header>
                <b-dropdown-item v-for="post in posts">

                  <template v-if="post.blogId==blog.blogId">
                    <b-card title="Usuario 1 dice: ">
                      <b-card-text>{{post.text}}</b-card-text>
                    </b-card>
                </b-dropdown-item>
                </template>

              </b-dropdown>
            </li>
          </ul>
        </b-card>
      </b-container>
      <b-alert v-show="blogId<0" variant="warning">No hay resultados</b-alert>

      <b-card>

        <!-- <b-table responsive :items="posts"></b-table> -->

        <b-form-group>
          <b-form-input v-model.trim="post" placeholder="Nuevo comentario" @keyup.enter="addPost">
          </b-form-input>
        </b-form-group>

      </b-card>
    </b-container>
  </div>
  <!-- Our application root element -->
  <!-- <div id="app">
      <b-container>
        <b-jumbotron header="BLOGS" lead="Demo de consumo de servicios con Vue2 y BootstrapVue">
          <p>Para más información consulta:</p>
          <b-btn variant="primary" href="https://bootstrap-vue.js.org/">Quiero saber más!</b-btn>
        </b-jumbotron>

        <b-form-group horizontal :label-cols="4" label="Dime tu nombre">
          <b-form-input v-model.trim="name"></b-form-input>
        </b-form-group>

        <b-alert variant="success" :show="showAlert">Bienvenido {{ name }}!</b-alert>
      
        <b-form-group horizontal :label-cols="4" label="Dime un tema">
          <b-form-input v-model.trim="query" placeholder="...por ejemplo motos" 
                        @keyup.enter="searchBlogs">
          </b-form-input>
        </b-form-group>

      <div v-show="blogs.length>0">
        <b-card title="Resultados">
       		<ul>
        	   <li v-for="blog in blogs">
                {{blog.description}} <b-button @click="getPosts(blog.blogId)">{{blog.name}}</b-button>
             </li>
      		</ul>
        </b-card>
      </div>

      <b-alert v-show="blogId<0" variant="warning">No hay resultados</b-alert>
      
      <b-card>

          <b-table responsive :items="posts"></b-table>

          <b-form-group>
             <b-form-input v-model.trim="post" placeholder="Nuevo comentario" 
                           @keyup.enter="addPost">
             </b-form-input>

      </b-card>


      </b-container>
    </div> -->

  <!-- Start running your app -->
  <script>
    window.app = new Vue({
      el: '#app',
      data: {
        username: '', //nombre de usuario (no se usa)
        userId: -1,
        query: '', //búsqueda
        blogId: -1, //blog activado
        blogName: '',
        blogDesc: '',
        category: '',
        postId: -1,
        users: [{
          "userId": 0,
          "password": "supersecreto",
          "email": "berejena@coco.com",
          "username": "anacleto"
        }],
        blogs: [{
          "name": "Comida con nabos",
          "description": "platos sencillos hechos de nabos",
          "authorId": 6,
          "category": "category",
          "blogId": 0,
          "tags": [
            "tags",
            "tags"
          ]
        },
        {
          "name": "Comida con zanahorias",
          "description": "platos sencillos hechos de zanahoria",
          "authorId": 6,
          "category": "category",
          "blogId": 1,
          "tags": [
            "tags",
            "tags"
          ]
        }
      ], //blogs de la búsqueda
        posts: [{
          "postId": 0,
          "text": "Madre mia me metia un nabo ente pecho y espalda",
          "authorId": 1,
          "blogId": 0
        }], //posts del blog activado
        post: ''  //nuevo post
      },
      computed: {
        showAlert() {
          return this.name.length > 2 ? true : false
        }
      },
      methods: {
        searchBlogs() {
          var self = this
          fetch('/blog?query=' + encodeURIComponent(this.query))
            .then(function (r) { return r.json() })
            .then(function (data) {
              console.log(data)
              self.blogs = data
            })
            .catch(function (error) { console.log(error) })
        },
        getPosts(blogId) {
          var self = this

          this.blogId = blogId

          fetch('/post/' + blogId)
            .then(function (r) { return r.json() })
            .then(function (data) {
              console.log(data)
              self.posts = data
            })
            .catch(function (error) { console.log(error) })
        },
        addPost() {
          var self = this
          this.postId += 1
          var postData = { postId: this.postId, text: this.post, authorId: 0, blogId: this.blogId }

          var opts = {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(postData)
          }

          fetch('/post/' + this.blogId, opts)
            .then(function (r) { return r.json() })
            .then(function (data) { console.log(data) })
            .catch(function (error) { console.log(error) })
        },
        addPost() {
          var self = this
          this.postId += 1
          var blogData = {}

          var opts = {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(blogData)
          }
        },
        created() {
          var self = this
          var ES = new EventSource('/news') //ruta API con notificaciones

          console.log('Creando listener de eventos de servidor...')

          ES.addEventListener('new-post', function (event) {
            var data = JSON.parse(JSON.parse(event.data))
            //bytes to string -> string to json
            //console.log(data)
            if (data.blogId == self.blogId)
              self.posts.push(data)
          }, false)
        },
        createUser() {
          var self = this
          var username = document.getElementById("regUser")
          var email = document.getElementById("regEmail")
          var pass = document.getElementById("regContraseña")
          let listaUsuarios = this.users.filter(u => u.username.toLowerCase().includes(username.value)
            || u.email.toLowerCase().includes(email.value))
          if (listaUsuarios.length != 0) {
            alert("Usuario o correo ya existen")
          }
          else {
            this.users.push({ userId: this.users.length, password: pass.value, email: email.value, username: username.value });
          }
          for (let i of this.users) {
            console.log(i.username)
          }
        },
        createBlog() {
          var self = this
          var title = document.getElementById("titulo")
          var content = document.getElementById("contenidoPost")
          var category = document.getElementById("categoria")
          alert(category.value)
          console.log(title.value+content.value+category)
        }
      }
    })
  </script>
</body>

</html>