<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

  <title>SelFit - Do IT yourself</title>

  <!-- Required Stylesheets -->
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css" />

  <!-- Required scripts -->
  <script src="https://unpkg.com/vue"></script>
  <script src="https://unpkg.com/babel-polyfill@latest/dist/polyfill.min.js"></script>
  <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
</head>

<body>
  <div id="app">
    <b-navbar toggleable="lg" type="dark" variant="dark">
      <b-navbar-brand>SelFit©</b-navbar-brand>

      <b-navbar-toggle target="nav-collapse"></b-navbar-toggle>

      <b-collapse id="nav-collapse" is-nav>
        <b-navbar-nav>
          <b-nav-item href="http://localhost:9000/web/">Home</b-nav-item>
        </b-navbar-nav>

        <!-- Right aligned nav items -->
        <b-navbar-nav class="ml-auto">
          <!-- <b-nav-form>
            <b-form-input size="sm" class="mr-sm-2" placeholder="Buscar posts"></b-form-input>
            <b-button size="sm" class="my-2 my-sm-0" type="submit">Buscar</b-button>
          </b-nav-form> -->
          <b-nav-item-dropdown text="Categorías" right>
            <b-form-group>
              <b-dropdown-item href="#">
                <!-- <b-form-button v-model="selected" :aria-describedby="ariaDescribedby" name="some-radios" value="comida"> -->
                <b-form-button name="categoria" value="comida">
                  Comida</b-form-button>
              </b-dropdown-item>

              <b-dropdown-item href="#">
                <b-form-button name="categoria" value="ejercicio">
                  Ejercicio</b-form-button>
              </b-dropdown-item>

              <b-dropdown-item href="#">
                <b-form-button name="categoria" value="vida">
                  Estilo de vida</b-form-button>
              </b-dropdown-item>

            </b-form-group>
          </b-nav-item-dropdown>

          <b-nav-item-dropdown right>
            <!-- Using 'button-content' slot -->
            <template #button-content>
              <em>Usuario</em>
            </template>
            <b-dropdown-item v-b-modal.modal-1>Iniciar Sesion</b-dropdown-item>
            <b-modal id="modal-1" centered title="Iniciar Sesión" hide-footer>
              <div class="row justify-content-center">
                <div>

                  <div class="card-body">
                    <div class="tab-content" id="pills-tabContent">
                      <div class="tab-pane fade show active" id="pills-beneficiary" role="tabpanel"
                        aria-labelledby="pills-beneficiary-tab">
                        <div class="vue-template">
                          <form>
                            <div class="form-group">
                              <h4>Usuario</h4>
                              <input type="text" class="form-control form-control-lg" />
                            </div>

                            <div class="form-group">
                              <h4>Contraseña</h4>
                              <input type="password" class="form-control form-control-lg" />
                            </div>

                            <button type="submit" class="btn btn-dark btn-lg btn-block">Iniciar sesión</button>

                            <p class="forgot-password text-right">
                              ¿No tienes cuenta?
                              <b-link v-b-modal.modal-2 @click="$bvModal.hide('modal-1')"> Regístrate</b-link>
                            </p>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </b-modal>
            <b-dropdown-item v-b-modal.modal-2>Regístrate</b-dropdown-item>
            <b-modal id="modal-2" centered title="Regístrate" hide-footer>
              <div class="row justify-content-center">
                <div>
                  <div class="card-body">
                    <div class="tab-content" id="pills-tabContent">
                      <div class="tab-pane fade show active" id="pills-beneficiary" role="tabpanel"
                        aria-labelledby="pills-beneficiary-tab">
                        <div class="vue-template">
                          <form>
                            <div class="form-group">
                              <h4>Usuario</h4>
                              <input type="text" class="form-control form-control-lg" />
                            </div>
                            <div class="form-group">
                              <h4>Email</h4>
                              <input type="password" class="form-control form-control-lg" />
                            </div>
                            <div class="form-group">
                              <h4>Contraseña</h4>
                              <input type="password" class="form-control form-control-lg" />
                            </div>
                            <button type="submit" class="btn btn-dark btn-lg btn-block">Regístrate</button>

                            <p class="forgot-password text-right">
                              ¿Ya tienes cuenta?
                              <b-link v-b-modal.modal-1 @click="$bvModal.hide('modal-2')"> Inicia Sesión</b-link>
                            </p>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </b-modal>
          </b-nav-item-dropdown>
        </b-navbar-nav>
      </b-collapse>
    </b-navbar>

    <br>
    </br>

    <b-container>
      <div class="input-group">
        <b-form-input v-model.trim="query" size="sm" class="mr-sm-2" placeholder="Buscar posts"
          @keyup.enter="searchBlogs"></b-form-input>
        <b-button type="submit" size="sm" class="my-2 my-sm-0" @click="searchBlogs">Buscar</button>
      </div>
      <b-container v-show="blogs.length>0">
        <b-card title="Resultados">
          <ul>
            <li v-for="blog in blogs">
              {{blog.description}} <b-button @click="getPosts(blog.blogId)">{{blog.name}}</b-button>
            </li>
          </ul>
        </b-card>
      </b-container>
      <b-alert v-show="blogId<0" variant="warning">No hay resultados</b-alert>

      <b-card>

        <b-table responsive :items="posts"></b-table>

        <b-form-group>
          <b-form-input v-model.trim="post" placeholder="Nuevo comentario" @keyup.enter="addPost">
          </b-form-input>

      </b-card>
    </b-container>
  </div>
  <!-- Our application root element -->
  <!-- <div id="app">
      <b-container>
        <b-jumbotron header="BLOGS" lead="Demo de consumo de servicios con Vue2 y BootstrapVue">
          <p>Para más información consulta:</p>
          <b-btn variant="primary" href="https://bootstrap-vue.js.org/">Quiero saber más!</b-btn>
        </b-jumbotron>

        <b-form-group horizontal :label-cols="4" label="Dime tu nombre">
          <b-form-input v-model.trim="name"></b-form-input>
        </b-form-group>

        <b-alert variant="success" :show="showAlert">Bienvenido {{ name }}!</b-alert>
      
        <b-form-group horizontal :label-cols="4" label="Dime un tema">
          <b-form-input v-model.trim="query" placeholder="...por ejemplo motos" 
                        @keyup.enter="searchBlogs">
          </b-form-input>
        </b-form-group>

      <div v-show="blogs.length>0">
        <b-card title="Resultados">
       		<ul>
        	   <li v-for="blog in blogs">
                {{blog.description}} <b-button @click="getPosts(blog.blogId)">{{blog.name}}</b-button>
             </li>
      		</ul>
        </b-card>
      </div>

      <b-alert v-show="blogId<0" variant="warning">No hay resultados</b-alert>
      
      <b-card>

          <b-table responsive :items="posts"></b-table>

          <b-form-group>
             <b-form-input v-model.trim="post" placeholder="Nuevo comentario" 
                           @keyup.enter="addPost">
             </b-form-input>

      </b-card>


      </b-container>
    </div> -->

  <!-- Start running your app -->
  <script>
    window.app = new Vue({
      el: '#app',
      data: {
        username: '', //nombre de usuario (no se usa)
        userId: -1,
        query: '', //búsqueda
        blogId: -1, //blog activado
<<<<<<< HEAD
        blogName: '',
        blogDesc: '',
        category: '',
        postId: -1,
        users: [],
        blogs: [], //blogs de la búsqueda
        posts: [], //posts del blog activado
=======
        blogs: [
          {
            "name": "nabo",
            "description": "nabo",
            "authorId": 0,
            "category": "comida",
            "blogId": 0,
            "tags": [
              "tags",
              "tags"
            ]
          }
          , {
            "name": "zurullo",
            "description": "zurullo",
            "authorId": 0,
            "category": "ejercicio",
            "blogId": 1,
            "tags": [
              "tags",
              "tags"
            ]
          }
        ], //blogs de la búsqueda
        posts: [
          {
            "postId": 0,
            "text": "Nabocop",
            "authorId": 0,
            "blogId": 0
          },
          {
            "postId": 1,
            "text": "Menudo zurullo he hecho",
            "authorId": 0,
            "blogId": 1
          }

        ], //posts del blog activado
>>>>>>> 31f87d8261378b20f4510d325699100ed02e17cb
        post: ''  //nuevo post
      },
      computed: {
        showAlert() {
          return this.name.length > 2 ? true : false
        }
      },
      methods: {
        searchBlogs() {
          var self = this
          fetch('/blog?query=' + encodeURIComponent(this.query))
            .then(function (r) { return r.json() })
            .then(function (data) {
              console.log(data)
              self.blogs = data
            })
            .catch(function (error) { console.log(error) })
        },
        getPosts(blogId) {
          var self = this

          this.blogId = blogId

          fetch('/post/' + blogId)
            .then(function (r) { return r.json() })
            .then(function (data) {
              console.log(data)
              self.posts = data
            })
            .catch(function (error) { console.log(error) })
        },
        addPost() {
          var self = this
          this.postId += 1
          var postData = { postId: this.postId, text: this.post, authorId: 0, blogId: this.blogId }

          var opts = {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(postData)
          }

          fetch('/post/' + this.blogId, opts)
            .then(function (r) { return r.json() })
            .then(function (data) { console.log(data) })
            .catch(function (error) { console.log(error) })
        },
        addPost() {
          var self = this
          this.postId += 1
          var blogData = {}

          var opts = {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(blogData)
          }
        },
        created() {
          var self = this
          var ES = new EventSource('/news') //ruta API con notificaciones

          console.log('Creando listener de eventos de servidor...')

          ES.addEventListener('new-post', function (event) {
            var data = JSON.parse(JSON.parse(event.data))
            //bytes to string -> string to json
            //console.log(data)
            if (data.blogId == self.blogId)
              self.posts.push(data)
          }, false)
        }
      }
    })
  </script>
</body>

</html>